# Dockit - 도커 개발 환경 프로젝트 소개

## 프로젝트 개요

Dockit은 개발자들이 Docker 기반 개발 환경을 빠르고 쉽게 설정할 수 있도록 하는 모듈식 쉘 스크립트 도구입니다. 이 프로젝트는 컨테이너 기반 개발 환경을 표준화하고, 설정 과정을 간소화하여 개발자들이 개발에 집중할 수 있도록 돕는 것을 목표로 합니다.

## 주요 특징

### 1. 모듈식 아키텍처

Dockit은 다음과 같은 독립적인 모듈로 구성되어 있습니다:

#### 핵심 모듈
- **common**: 공통 유틸리티 함수 및 변수
- **init**: 초기 설정 및 프로젝트 환경 구성
- **build**: Docker 이미지 빌드 관리
- **start**: 컨테이너 시작 관리
- **up**: 컨테이너 백그라운드 시작 관리
- **stop**: 컨테이너 정지 관리 (상태 보존)
- **down**: 컨테이너 완전 제거 관리
- **connect**: 실행 중인 컨테이너에 쉽게 접속
- **status**: 컨테이너 및 이미지 상태 확인
- **help**: 도움말 및 사용법 안내

#### 편의 기능 모듈
- **run**: 상호작용 없이 자동으로 초기화, 빌드, 시작을 수행
- **setup**: 초기화, 빌드, 시작, 접속을 한 번에 수행
- **list**: dockit으로 생성된 모든 컨테이너 목록 조회
- **base**: 베이스 이미지 관리 (ls, set, add, remove, validate, reset)
- **ps**: 컨테이너 프로세스 상태 확인
- **clone**: 기존 프로젝트를 복제하여 새 프로젝트 생성 (v1.8.x)
- **registry**: 컨테이너 레지스트리 관리
- **migrate**: 새 버전으로 업그레이드
- **container_base**: 컨테이너 기본 기능 제공

이러한 모듈식 설계는 코드 유지보수와 확장을 용이하게 합니다.

### 2. 깔끔한 파일 구조

Dockit은 코드 구조의 명확성과 유지보수성을 높이기 위해 다음과 같은 디렉토리 구조를 채택했습니다:

- **src**: 모든 소스 코드가 포함된 디렉토리
  - **modules**: 기능별로 분리된 쉘 스크립트 모듈
  - **templates**: Docker 이미지 및 Compose 파일 템플릿
  - **utils**: 공통 유틸리티 함수들 (로깅, 파일 처리, 시스템 유틸리티 등)
  - **completion**: 자동완성 시스템 (bash, zsh 지원)
  - **dev**: 개발 및 테스트 도구들
- **bin**: 설치/제거 스크립트 및 버전 정보
- **docs**: 다국어 문서 및 프로젝트 메타데이터
- **config**: 설정 파일들
- **.dockit_project**: 모든 생성 파일을 한 곳에서 관리하는 디렉토리

이러한 구조는 다음과 같은 이점을 제공합니다:
- 프로젝트 루트 디렉토리가 깔끔하게 유지됨
- 소스 코드(src)와 생성 파일(.dockit_project)이 명확히 분리됨
- 기능별로 체계적으로 분류된 모듈 구조
- 개발 도구와 유틸리티의 명확한 분리
- 버전 관리 시스템에서 생성 파일을 쉽게 제외할 수 있음
- 표준적인 프로젝트 구조를 따라 이해하기 쉬움

### 3. 사용자 친화적 인터페이스

- 대화형 설치 과정으로 사용자가 쉽게 설정을 커스터마이즈할 수 있음
- 컬러 출력으로 중요한 정보를 강조하여 가독성 향상
- 자세한 로깅으로 문제 해결이 용이함
- bash 및 zsh 자동완성 지원으로 명령어 입력 편의성 향상
- 개발자를 위한 디버깅 및 테스트 도구 제공
- **디렉터리 이름 검증 및 자동 변경**: Docker 이미지 이름 규칙에 맞지 않는 대문자 포함 디렉터리명 자동 감지 및 변환 제안

### 4. 컨테이너-호스트 권한 문제 해결

개발 컨테이너에서 발생하는 일반적인 문제 중 하나는 파일 권한 관리입니다. Dockit은:

- 호스트 사용자의 UID/GID를 컨테이너 내부 사용자에게 적용
- **UID 충돌 자동 감지**: 베이스 이미지에 동일한 UID를 가진 사용자가 존재하는 경우 자동 감지
- **스마트 비밀번호 할당**: 실제 컨테이너 사용자(예: ubuntu)에게 자동으로 비밀번호 설정
- **조건부 사용자 처리**: 기존 사용자 활용 vs 새 사용자 생성을 자동으로 결정
- **Docker 캐싱 제어**: `--no-cache` 옵션으로 변경사항이 제대로 반영되도록 지원
- 볼륨 마운트 시 권한 문제를 자동으로 해결하는 메커니즘 제공
- 볼륨 마운트를 통해 호스트와 컨테이너 간 원활한 파일 공유 지원

**최신 v1.8.4 기능:**
- `getent passwd ${USER_UID}`를 통한 UID 기반 사용자 확인
- `usermod + openssl passwd + passwd -u` 조합으로 안전한 비밀번호 설정
- 사용자 커스터마이징 가능한 Dockerfile (`.dockit_project/Dockerfile` 직접 수정 지원)
- **지능형 동기화**: Docker 이미지 목록 비교를 통한 조건부 API 호출로 불필요한 작업 최소화
- **향상된 상태 관리**: 컨테이너 상태 캐싱 및 실시간 동기화로 `dockit ps`와 `dockit list` 간 일관성 보장
- **자동 프로젝트 발견**: 미등록된 dockit 프로젝트의 자동 감지 및 등록

### 5. 직관적인 컨테이너 관리 명령어

Dockit은 컨테이너 관리를 위한 명확하게 구분된 명령어를 제공합니다:

#### 기본 관리 명령어
- **init**: 개발 환경을 초기화하고 설정합니다.
- **build**: Docker 이미지를 빌드합니다.
- **start**: 컨테이너를 시작합니다. 컨테이너가 없으면 새로 생성합니다.
- **up**: 컨테이너를 백그라운드에서 시작합니다.
- **stop**: 컨테이너를 정지만 하고 상태는 유지합니다. 나중에 `start`로 다시 시작할 수 있습니다.
- **down**: 컨테이너를 완전히 제거합니다. 컨테이너 내부의 모든 데이터가 삭제됩니다.
- **connect**: 실행 중인 컨테이너에 접속합니다.
- **status**: 컨테이너의 현재 상태를 확인하고 다음에 수행할 수 있는 명령어를 안내합니다.

#### 편의 명령어
- **run**: 상호작용 없이 자동으로 초기화, 빌드, 시작을 수행합니다.
- **setup**: 초기화, 빌드, 시작, 접속을 한 번에 수행합니다.
- **list**: dockit으로 생성된 모든 컨테이너 목록을 조회합니다.
- **base**: 베이스 이미지 관리 (목록 보기, 설정, 추가, 제거, 검증, 초기화) 및 번호 기반 선택을 지원합니다.
- **ps**: 컨테이너 프로세스 상태를 확인합니다.
- **clone**: 기존 프로젝트를 복제하여 유사한 환경의 새 프로젝트를 생성합니다. (v1.8.x)

#### 고급 기능
- **registry**: 컨테이너 레지스트리를 관리합니다.
- **migrate**: 새 버전으로 업그레이드합니다.

모든 명령어는 번호, "this", "all" 옵션을 지원하여 여러 컨테이너를 효율적으로 관리할 수 있습니다.

이 구분된 명령어 체계는 사용자의 의도에 맞는 정확한 동작을 수행하여 실수를 방지합니다.

### 6. 프로젝트 복제 시스템 (v1.8.x)

기존 프로젝트를 기반으로 새로운 개발 환경을 빠르게 구축할 수 있는 고급 복제 기능:

#### 지능형 프로젝트 복제
- **컨테이너 상태 복제**: 실행 중인 컨테이너의 현재 상태를 그대로 보존
- **설정 파일 복사**: `.dockit_project` 디렉토리의 모든 설정을 새 프로젝트로 복제
- **자동 이름 관리**: 프로젝트 이름 충돌 방지 및 유효한 Docker 이름 자동 생성
- **롤백 메커니즘**: 복제 실패 시 생성된 모든 리소스 자동 정리

#### 복제 방식
- **번호 기반**: `dockit clone 1` - 프로젝트 목록 번호로 복제
- **ID 기반**: `dockit clone abc123ef` - 프로젝트 ID (전체 또는 고유 접두사)로 복제
- **대화형 모드**: 새 프로젝트 이름을 대화식으로 입력
- **배치 모드**: `dockit clone 1 new-project` - 명령행에서 직접 이름 지정

### 7. 상태 관리 시스템 (v1.8.4)

Dockit v1.8.4에서 도입된 성능 최적화 및 상태 관리 기능:

#### 지능형 동기화
- **조건부 Docker API 호출**: 레지스트리와 Docker 이미지 목록을 비교하여 변경사항이 있을 때만 동기화 수행
- **성능 향상**: `dockit list` 명령어 실행 시간을 2초 이상에서 약 1.3초로 대폭 단축
- **자원 효율성**: 불필요한 Docker API 호출을 최소화하여 시스템 부하 감소

#### 향상된 캐싱 메커니즘
- **이미지 캐싱**: Docker 이미지 목록을 메모리에 캐시하여 중복 조회 방지
- **컨테이너 상태 캐싱**: 실행 중인 컨테이너 상태를 배치로 조회하고 캐시 저장
- **독립적 상태 관리**: 컨테이너 상태와 이미지 상태를 분리하여 각각 최적화

#### 실시간 상태 동기화
- **일관성 보장**: `dockit ps`와 `dockit list` 명령어 간 상태 정보 일치
- **실시간 업데이트**: 컨테이너 상태 변경 시 즉시 레지스트리에 반영
- **자동 복구**: 상태 불일치 발생 시 자동으로 실제 Docker 상태에 맞춰 수정

#### 자동 프로젝트 관리
- **미등록 프로젝트 발견**: Docker에만 존재하는 dockit 컨테이너를 자동으로 감지
- **자동 등록**: 발견된 프로젝트를 레지스트리에 자동으로 추가
- **경로 추적**: 프로젝트 디렉토리와 Docker 이미지/컨테이너의 연결 관계 자동 복원

## 기술적 구현

### 설정 파일 관리

Dockit은 `.dockit_project/.env` 파일에 모든 설정을 저장합니다. 이 파일은:

1. 최초 설치 시 사용자 입력을 통해 생성됨
2. 후속 실행 시 자동으로 로드됨
3. 언제든지 수동으로 편집 가능함

### 도커 이미지 템플릿

기본 Dockerfile 템플릿은 다음 기능을 제공합니다:

- 사용자 생성 및 sudo 권한 설정
- 한국어 로케일 지원
- 개발 도구 및 유틸리티 설치
- 작업 디렉토리 구성 및 권한 설정

### 자동완성 시스템

Dockit은 bash와 zsh 모두에서 자동완성을 지원합니다:

- **bash 자동완성**: `src/completion/bash.sh`에서 구현
- **zsh 자동완성**: `src/completion/zsh.sh`에서 구현
- **공통 로직**: `src/completion/completion-common.sh`에서 명령어 및 옵션 처리
- 설치 시 자동으로 쉘 설정에 추가됨

### 유틸리티 시스템

확장된 유틸리티 시스템으로 코드 재사용성과 유지보수성을 향상시켰습니다:

- **로깅 시스템** (`src/utils/log.sh`): 구조화된 로그 출력 및 관리
- **파일 처리** (`src/utils/file.sh`): 파일 및 디렉토리 조작 유틸리티
- **시스템 유틸리티** (`src/utils/system.sh`): 시스템 정보 및 환경 관리
- **비동기 작업** (`src/utils/async_tasks.sh`): 백그라운드 작업 처리
- **범용 유틸리티** (`src/utils/utils.sh`): 공통 헬퍼 함수들

### 개발 및 테스트 도구

개발자를 위한 포괄적인 테스트 및 디버깅 도구를 제공합니다:

- **모듈 테스트**: 개별 모듈의 기능 검증
- **상태 테스트**: 컨테이너 상태 관리 검증
- **설정 테스트**: 환경 설정 검증
- **마이그레이션 테스트**: 버전 업그레이드 검증
- **디버깅 도구**: 문제 진단 및 해결 지원

### 컨테이너 레지스트리 관리

Dockit으로 생성된 모든 컨테이너를 중앙에서 관리합니다:

- 컨테이너 목록 자동 추적
- 프로젝트별 컨테이너 그룹화  
- 일괄 작업 지원 (start all, stop all 등)
- **v1.8.4 개선사항**: 
  - JSON 기반 레지스트리 구조로 확장성과 성능 향상
  - 실시간 상태 동기화로 데이터 일관성 보장
  - 지능형 캐싱으로 조회 성능 최적화

### 성능 최적화 아키텍처 (v1.8.4)

적인 성능 최적화를 위한 다층 캐싱 시스템:

#### 캐싱 계층 구조
- **L1 Cache**: 메모리 내 Docker 이미지 목록 캐시 (`LOCAL_DOCKIT_IMAGES_CACHE`)
- **L2 Cache**: 연관 배열 기반 컨테이너 상태 캐시 (`CONTAINER_STATES_CACHE`)
- **Smart Invalidation**: 변경 감지 시에만 캐시 무효화

#### 조건부 동기화 알고리즘
```bash
# 성능 최적화 핵심 로직
should_sync_docker_status() {
    # 1. Docker 이미지 목록과 레지스트리 이미지 목록 비교
    # 2. 변경사항 없으면 동기화 스킵 (Docker API 호출 없음)
    # 3. 변경사항 있을 때만 전체 동기화 수행
}
```

#### 배치 처리 최적화
- **이미지 조회**: 단일 `docker image ls` 명령으로 모든 dockit 이미지 조회
- **컨테이너 상태**: `docker container ls -a --filter` 로 대상 컨테이너만 배치 조회
- **상태 파싱**: 연관 배열 활용으로 O(1) 조회 성능 달성

### 마이그레이션 지원

기존 버전에서 새 버전으로의 마이그레이션을 자동화했습니다:

- 이전 버전의 설정 파일 자동 감지 및 새 위치로 이동
- 오래된 로그 파일 정리
- 이전 참조명(docker-tools)을 새 이름(dockit)으로 변경
- 설정 파일 형식 업그레이드

## 사용 사례

Dockit은 다음과 같은 상황에서 특히 유용합니다:

1. **팀 프로젝트**: 모든 개발자가 동일한 개발 환경을 사용해야 할 때
2. **프로젝트별 격리**: 로컬 환경 설정을 복잡하게 하지 않고 프로젝트별 의존성을 관리하고 싶을 때
3. **크로스 플랫폼**: 리눅스, macOS, Windows(WSL) 등 서로 다른 운영체제에서 일관된 개발 환경이 필요할 때
4. **Docker 간소화**: Docker를 사용하지만 docker-compose 명령어를 매번 입력하기 번거로울 때
5. **대규모 프로젝트** (v1.8.4): 여러 개의 컨테이너화된 프로젝트를 효율적으로 관리해야 할 때
   - 자동 프로젝트 발견으로 수동 등록 작업 최소화
   - 실시간 상태 동기화로 일관된 정보 제공
6. **성능 민감 환경**: Docker API 호출을 최소화하여 시스템 자원을 절약해야 할 때
7. **프로젝트 복제** (v1.8.x): 기존 개발 환경을 기반으로 유사한 프로젝트를 빠르게 생성해야 할 때
   - 설치된 패키지와 설정이 포함된 컨테이너 상태 복제
   - 테스트 환경, 브랜치별 환경 구축에 최적화
   - 팀원 간 동일한 개발 환경 공유


## 결론

Dockit v1.8.4은 Docker의 강력함과 쉬운 사용성을 결합한 고성능 개발 환경 관리 도구로, 개발자들이 복잡한 Docker 설정에 시간을 낭비하지 않고 빠르게 개발을 시작할 수 있도록 도와줍니다. 
